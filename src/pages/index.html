<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Travel By Road Distance Demo (Geoapify)</title>
  <style>
    body { font-family: sans-serif; margin: 30px; }
    #results { margin-top: 20px; }
    .error { color: red; }
    input, button { font-size: 1rem; padding: 6px; border-radius: 5px; }
    input { border: 1px solid #ccc; margin-right: 5px; }
    button { border: none; background: #4682ef; color: #fff; }
    label { font-size: 1rem; }
  </style>
</head>
<body>
  <h1>Travel By Road Distance Demo (Geoapify)</h1>
  <div>
    <label>Destination (address, city or lat,lon):</label>
    <input id="destination" placeholder="e.g., Times Square, New York" size="40">
    <button id="route-btn">Find Driving Distance</button>
  </div>
  <div id="status"></div>
  <div id="results"></div>

  <script>
    // Replace with your key from https://myprojects.geoapify.com/
    const GEOAPIFY_API_KEY = "7c30108be08f414cbb99cc7947bf16e5";

    let userLat = null, userLon = null;

    // Get user's location on page load
    navigator.geolocation.getCurrentPosition(
      pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        document.getElementById("status").textContent = `Your location: ${userLat.toFixed(5)}, ${userLon.toFixed(5)}`;
      },
      err => {
        document.getElementById("status").innerHTML = `<span class="error">Location error: ${err.message}</span>`;
      }
    );

    document.getElementById("route-btn").onclick = function() {
      const dest = document.getElementById("destination").value.trim();
      document.getElementById("results").innerHTML = "";
      if (!userLat || !userLon) {
        document.getElementById("results").innerHTML = "<span class='error'>Can't get your current location.</span>";
        return;
      }
      if (!dest) {
        document.getElementById("results").innerHTML = "<span class='error'>Enter a destination.</span>";
        return;
      }

      // If the user enters coordinates
      let destLat = null, destLon = null;
      if (/^-?\d+(\.\d+)?[, ]\s*-?\d+(\.\d+)?$/.test(dest)) {
        // Format: lat,lon
        [destLat, destLon] = dest.split(/[, ]/).map(Number);
        fetchRoute(userLat, userLon, destLat, destLon);
      } else {
        // Geocode the address first
        geocode(dest).then(res => {
          if (!res) {
            document.getElementById("results").innerHTML = "<span class='error'>Could not find destination address.</span>";
            return;
          }
          fetchRoute(userLat, userLon, res.lat, res.lon);
        });
      }
    };

    function geocode(query) {
      // Use Geoapify Geocoding API
      const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(query)}&limit=1&apiKey=${GEOAPIFY_API_KEY}`;
      return fetch(url)
        .then(r => r.json())
        .then(data => {
          if (data.features && data.features.length > 0) {
            const coords = data.features[0].geometry.coordinates;
            return { lon: coords[0], lat: coords[1] };
          } else {
            return null;
          }
        });
    }

    function fetchRoute(startLat, startLon, endLat, endLon) {
      // Geoapify Routing API for driving directions
      const url = `https://api.geoapify.com/v1/routing?waypoints=${startLat},${startLon}|${endLat},${endLon}&mode=drive&apiKey=${GEOAPIFY_API_KEY}`;
      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (!data.features || !data.features[0]) {
            document.getElementById("results").innerHTML = "<span class='error'>No route found.</span>";
            return;
          }
          const props = data.features[0].properties;
          const distanceKm = (props.distance / 1000).toFixed(2);
          const timeMin = Math.round(props.time / 60);
          document.getElementById("results").innerHTML = `
            <div>
              <b>Driving distance:</b> ${distanceKm} km<br>
              <b>Estimated time:</b> ${timeMin} min
            </div>
          `;
        })
        .catch(() => {
          document.getElementById("results").innerHTML = "<span class='error'>Could not fetch route. Please check your API key or try again later.</span>";
        });
    }
  </script>
</body>
</html>